<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>F1 Race Replay</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #111; color: white; padding: 20px;}
        canvas { background-color: #222; border: 2px solid #444; border-radius: 8px; box-shadow: 0px 4px 15px rgba(0,0,0,0.5); }
        button { padding: 12px 24px; font-size: 16px; margin-bottom: 20px; cursor: pointer; background-color: #e10600; color: white; border: none; border-radius: 4px; font-weight: bold;}
        button:disabled { background-color: #555; cursor: not-allowed; }
    </style>
</head>
<body>

    <h2>2023 Monaco GP - Fernando Alonso</h2>
    <button id="startRace">Start Race Simulation</button>
    <br>
    <canvas id="trackCanvas" width="800" height="600"></canvas>

    <script>
        const canvas = document.getElementById('trackCanvas');
        const ctx = canvas.getContext('2d');
        
        let raceData = [];
        let minX = Infinity, maxX = -Infinity;
        let minY = Infinity, maxY = -Infinity;
        let scale = 1;
        let offsetX = 0, offsetY = 0;

        // 1. Fetch data from your Django Backend
        async function fetchRaceData() {
            try {
                // This calls the urls.py route we set up in Django!
                const response = await fetch('api/locations/9094/14/');
                const data = await response.json();
                raceData = data.locations;
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Make sure you ran the Python fetch script first!");
            }
        }

        // 2. Calculate the boundaries so the track fits the canvas
        function calculateScale() {
            if (raceData.length === 0) return;

            raceData.forEach(point => {
                if (point.x < minX) minX = point.x;
                if (point.x > maxX) maxX = point.x;
                if (point.y < minY) minY = point.y;
                if (point.y > maxY) maxY = point.y;
            });

            const trackWidth = maxX - minX;
            const trackHeight = maxY - minY;
            
            const padding = 0.9; // Leave a 10% margin so the car doesn't hit the walls
            const scaleX = canvas.width / trackWidth;
            const scaleY = canvas.height / trackHeight;
            
            scale = Math.min(scaleX, scaleY) * padding;
            
            offsetX = (canvas.width - (trackWidth * scale)) / 2;
            offsetY = (canvas.height - (trackHeight * scale)) / 2;
        }

        // 3. Convert F1 Coordinates to Canvas Pixels
        function getCanvasCoords(rawX, rawY) {
            return {
                x: ((rawX - minX) * scale) + offsetX,
                y: ((maxY - rawY) * scale) + offsetY // Invert the Y-axis for screen rendering
            };
        }

        // 4. The Animation Loop
        function simulateRace() {
            if (raceData.length === 0) return;

            let currentIndex = 0;
            
            // (Bonus) Draw a faint outline of the whole track first so we can see the layout
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            raceData.forEach((point, index) => {
                const coords = getCanvasCoords(point.x, point.y);
                if (index === 0) ctx.moveTo(coords.x, coords.y);
                else ctx.lineTo(coords.x, coords.y);
            });
            ctx.stroke();

            // The loop that moves the car
            function drawNextFrame() {
                if (currentIndex >= raceData.length - 1) {
                    document.getElementById('startRace').innerText = "Race Finished";
                    return; 
                }

                const currentPoint = raceData[currentIndex];
                const nextPoint = raceData[currentIndex + 1];
                const coords = getCanvasCoords(currentPoint.x, currentPoint.y);

                // Draw the car (Aston Martin green, or Red for visibility!)
                ctx.fillStyle = '#00ff00'; 
                ctx.beginPath();
                ctx.arc(coords.x, coords.y, 4, 0, Math.PI * 2);
                ctx.fill();

                // Calculate the exact real-world time difference between these two points
                const timeDiff = new Date(nextPoint.date).getTime() - new Date(currentPoint.date).getTime();
                
                currentIndex++;
                
                // Wait for that exact time gap, then draw the next point
                setTimeout(drawNextFrame, timeDiff);
            }

            drawNextFrame(); // Kick off the loop
        }

        // 5. Hook it all up to the button
        document.getElementById('startRace').addEventListener('click', async () => {
            const btn = document.getElementById('startRace');
            btn.disabled = true;
            btn.innerText = "Loading data...";
            
            await fetchRaceData();
            calculateScale();
            
            btn.innerText = "Race in Progress";
            simulateRace();
        });
    </script>
</body>
</html>